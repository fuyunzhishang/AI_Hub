name: Docker Deploy to Production

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # æ£€å‡ºä»£ç 
    - name: Checkout Code
      uses: actions/checkout@v3

    # è®¾ç½® Docker Buildx
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    # æ„å»º Docker é•œåƒ
    - name: Build Docker Image
      run: |
        docker build -t ai-hub:latest .
        docker save ai-hub:latest | gzip > ai-hub.tar.gz

    # ä¸Šä¼ é•œåƒåˆ°æœåŠ¡å™¨
    - name: Upload Docker Image
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        username: ${{ secrets.DEPLOY_USER }}
        password: ${{ secrets.DEPLOY_PASS }}
        source: "ai-hub.tar.gz,docker-compose.yml"
        target: "/tmp/"

    # éƒ¨ç½²åˆ°æœåŠ¡å™¨
    - name: Deploy to Server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        username: ${{ secrets.DEPLOY_USER }}
        password: ${{ secrets.DEPLOY_PASS }}
        command_timeout: 30m
        script: |
          set -e
          
          # å®šä¹‰å˜é‡
          APP_DIR="/var/www/ai-hub"
          BACKUP_DIR="${APP_DIR}/backups"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          
          # åˆ›å»ºç›®å½•ç»“æ„
          echo "åˆ›å»ºç›®å½•ç»“æ„..."
          mkdir -p ${APP_DIR}/{uploads,logs,backups}
          cd ${APP_DIR}
          
          # å¤‡ä»½å½“å‰ç‰ˆæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f "docker-compose.yml" ]; then
            echo "å¤‡ä»½å½“å‰é…ç½®..."
            cp docker-compose.yml ${BACKUP_DIR}/docker-compose.yml.${TIMESTAMP}
          fi
          
          # å¤åˆ¶æ–°çš„ docker-compose.yml
          cp /tmp/docker-compose.yml ${APP_DIR}/
          
          # æ£€æŸ¥ Docker æ˜¯å¦å®‰è£…
          if ! command -v docker &> /dev/null; then
            echo "Docker æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… Dockerï¼"
            exit 1
          fi
          
          # æ£€æŸ¥ Docker Compose æ˜¯å¦å®‰è£…
          if ! command -v docker-compose &> /dev/null; then
            # å°è¯•ä½¿ç”¨ docker compose (æ–°ç‰ˆæœ¬)
            if ! docker compose version &> /dev/null; then
              echo "Docker Compose æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…..."
              # å®‰è£… Docker Compose
              curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              chmod +x /usr/local/bin/docker-compose
            fi
          fi
          
          # åŠ è½½æ–°é•œåƒ
          echo "åŠ è½½ Docker é•œåƒ..."
          docker load < /tmp/ai-hub.tar.gz
          rm -f /tmp/ai-hub.tar.gz
          
          # æ£€æŸ¥ç¯å¢ƒå˜é‡æ–‡ä»¶
          if [ ! -f "${APP_DIR}/.env" ]; then
            echo "è­¦å‘Šï¼š.env æ–‡ä»¶ä¸å­˜åœ¨ï¼"
            echo "è¯·åˆ›å»º .env æ–‡ä»¶å¹¶é…ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š"
            echo "TENCENTCLOUD_SECRET_ID=your_secret_id"
            echo "TENCENTCLOUD_SECRET_KEY=your_secret_key"
            
            # åˆ›å»ºç¤ºä¾‹ .env æ–‡ä»¶
            cat > ${APP_DIR}/.env.example << EOF
          # Tencent Cloud Credentials
          TENCENTCLOUD_SECRET_ID=your_secret_id
          TENCENTCLOUD_SECRET_KEY=your_secret_key
          
          # Application Config
          PORT=3099
          NODE_ENV=production
          EOF
          fi
          
          # åœæ­¢æ—§å®¹å™¨
          echo "åœæ­¢æ—§å®¹å™¨..."
          docker-compose down || docker compose down || true
          
          # å¯åŠ¨æ–°å®¹å™¨
          echo "å¯åŠ¨æ–°å®¹å™¨..."
          if command -v docker-compose &> /dev/null; then
            docker-compose up -d
          else
            docker compose up -d
          fi
          
          # ç­‰å¾…å®¹å™¨å¯åŠ¨
          echo "ç­‰å¾…æœåŠ¡å¯åŠ¨..."
          sleep 10
          
          # æ˜¾ç¤ºå®¹å™¨çŠ¶æ€
          echo "å®¹å™¨çŠ¶æ€ï¼š"
          docker ps -a | grep ai-hub || true
          
          # æ˜¾ç¤ºå®¹å™¨æ—¥å¿—
          echo "æœ€è¿‘çš„å®¹å™¨æ—¥å¿—ï¼š"
          docker logs --tail 50 ai-hub || true
          
          # æ¸…ç†æ—§é•œåƒ
          echo "æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ..."
          docker image prune -f || true
          
          echo "éƒ¨ç½²å®Œæˆï¼"

    # å¥åº·æ£€æŸ¥
    - name: Health Check
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        port: ${{ secrets.DEPLOY_PORT || 22 }}
        username: ${{ secrets.DEPLOY_USER }}
        password: ${{ secrets.DEPLOY_PASS }}
        script: |
          # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
          echo "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
          
          # æ£€æŸ¥å®¹å™¨çŠ¶æ€
          if ! docker ps | grep -q ai-hub; then
            echo "é”™è¯¯ï¼šå®¹å™¨æœªè¿è¡Œï¼"
            docker ps -a
            exit 1
          fi
          
          # HTTP å¥åº·æ£€æŸ¥
          HEALTH_URL="http://localhost:3099/api/test"
          MAX_ATTEMPTS=10
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "å¥åº·æ£€æŸ¥å°è¯• $ATTEMPT/$MAX_ATTEMPTS..."
            
            if curl -f -s -o /dev/null -w "%{http_code}" $HEALTH_URL | grep -q "200"; then
              echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ï¼"
              
              # æ˜¾ç¤ºå®¹å™¨ä¿¡æ¯
              echo "å®¹å™¨è¿è¡ŒçŠ¶æ€ï¼š"
              docker ps | grep ai-hub
              
              # æ˜¾ç¤ºç«¯å£ç›‘å¬
              echo "ç«¯å£ç›‘å¬çŠ¶æ€ï¼š"
              netstat -tlpn | grep :3099 || ss -tlpn | grep :3099 || true
              
              exit 0
            else
              echo "ç­‰å¾…æœåŠ¡å“åº”..."
              sleep 5
            fi
            
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          # å¥åº·æ£€æŸ¥å¤±è´¥
          echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼"
          echo "å®¹å™¨æ—¥å¿—ï¼š"
          docker logs --tail 100 ai-hub
          exit 1

    # æ¸…ç†å·¥ä½œæµäº§ç‰©
    - name: Cleanup
      if: always()
      run: |
        rm -f ai-hub.tar.gz

    # æˆåŠŸé€šçŸ¥
    - name: Success Notification
      if: success()
      run: |
        echo "ğŸ‰ Docker éƒ¨ç½²æˆåŠŸï¼"
        echo "éƒ¨ç½²æ—¶é—´: $(date)"
        echo "Git æäº¤: ${{ github.sha }}"